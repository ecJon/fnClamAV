name: Build and Release FPK

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version to build (e.g., 1.3.1)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false  # 一个架构失败不影响另一个
      matrix:
        include:
          - arch: x86_64
            runner: ubuntu-latest
            platform: x86
          - arch: aarch64
            runner: ubuntu-24.04-arm
            platform: arm64

    runs-on: ${{ matrix.runner }}
    container:
      image: debian:12
      options: --user root

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref_name }}

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION for ${{ matrix.arch }}"

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            curl \
            git \
            file \
            zlib1g-dev \
            libssl-dev \
            libcurl4-openssl-dev \
            libjson-c-dev \
            libbz2-dev \
            liblzma-dev \
            libzstd-dev \
            libpcre2-dev \
            ninja-build \
            libxml2-dev \
            libncurses-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Clean old architecture files
        run: |
          # 清理仓库中的旧架构文件，确保不会链接错误的库
          rm -rf app/lib app/bin app/include
          echo "Cleaned app/lib, app/bin, app/include"

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust-server/target
          key: ${{ matrix.arch }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ matrix.arch }}-cargo-

      - name: Cache ClamAV build
        id: cache-clamav
        uses: actions/cache@v4
        with:
          path: |
            app/lib
            app/bin
            app/include
          key: ${{ matrix.arch }}-clamav-1.5.1-v1
          restore-keys: |
            ${{ matrix.arch }}-clamav-

      - name: Clone ClamAV source
        if: steps.cache-clamav.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/Cisco-Talos/clamav.git clamAV
          cd clamAV
          git checkout clamav-1.5.1

      - name: Build ClamAV
        if: steps.cache-clamav.outputs.cache-hit != 'true'
        run: |
          echo "Building ClamAV shared library for ${{ matrix.arch }}..."
          mkdir -p clamAV/build
          cd clamAV/build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/app \
            -DBUILD_SHARED_LIBS=ON \
            -DENABLE_STATIC_LIB=OFF \
            -DENABLE_TESTS=OFF \
            -DENABLE_EXAMPLES=OFF \
            -DENABLE_MILTER=OFF \
            -DENABLE_CLAMONACC=OFF \
            -DENABLE_UNRAR=ON \
            -GNinja
          ninja
          ninja install

      - name: Download virus database
        run: |
          mkdir -p app/share/clamav
          cd app/share/clamav
          # 清理旧的病毒库文件（如果有）
          rm -f *.cvd *.cld 2>/dev/null || true

          # Download main.cvd (~85MB)
          echo "Downloading main.cvd..."
          curl -L --fail --retry 3 --retry-delay 5 \
            -A "ClamAV/1.5.1" \
            -o main.cvd \
            https://database.clamav.net/main.cvd

          # Download daily.cvd (~23MB)
          echo "Downloading daily.cvd..."
          curl -L --fail --retry 3 --retry-delay 5 \
            -A "ClamAV/1.5.1" \
            -o daily.cvd \
            https://database.clamav.net/daily.cvd

          # Download bytecode.cvd (~276KB)
          echo "Downloading bytecode.cvd..."
          curl -L --fail --retry 3 --retry-delay 5 \
            -A "ClamAV/1.5.1" \
            -o bytecode.cvd \
            https://database.clamav.net/bytecode.cvd

          echo "Virus database files:"
          ls -lh

          # 验证文件大小
          echo ""
          echo "Verifying file sizes..."
          MAIN_SIZE=$(stat -c%s main.cvd 2>/dev/null || stat -f%z main.cvd)
          DAILY_SIZE=$(stat -c%s daily.cvd 2>/dev/null || stat -f%z daily.cvd)
          BYTECODE_SIZE=$(stat -c%s bytecode.cvd 2>/dev/null || stat -f%z bytecode.cvd)

          if [ "$MAIN_SIZE" -lt 10000000 ]; then
            echo "ERROR: main.cvd is too small ($MAIN_SIZE bytes), expected ~85MB"
            exit 1
          fi
          if [ "$DAILY_SIZE" -lt 1000000 ]; then
            echo "ERROR: daily.cvd is too small ($DAILY_SIZE bytes), expected ~23MB"
            exit 1
          fi
          echo "✅ Virus database files verified successfully"

      - name: Build Rust daemon
        run: |
          cd rust-server
          cargo build --release
          mkdir -p ../app/server
          cp target/release/clamav-daemon ../app/server/
          chmod +x ../app/server/clamav-daemon

      - name: Verify app directory before packaging
        run: |
          echo "=== App directory structure ==="
          echo "Total size:"
          du -sh app/
          echo ""
          echo "Subdirectories:"
          du -sh app/*/
          echo ""
          echo "=== Virus database files ==="
          ls -lh app/share/clamav/
          echo ""
          echo "=== ClamAV libraries ==="
          ls -lh app/lib/
          echo ""
          echo "=== ClamAV binaries ==="
          ls -lh app/bin/
          echo ""
          echo "=== Architecture ==="
          file app/server/clamav-daemon

      - name: Package FPK
        run: |
          chmod +x build.sh
          ./build.sh --skip-clamav --platform ${{ matrix.platform }}

          # Rename FPK with version and arch
          VERSION="${{ steps.version.outputs.version }}"
          ARCH="${{ matrix.arch }}"
          mv dist/fnnas.clamav.fpk dist/fnnas.clamav-${VERSION}-${ARCH}.fpk

          echo "fpk_path=dist/fnnas.clamav-${VERSION}-${ARCH}.fpk" >> $GITHUB_OUTPUT
          echo "fpk_name=fnnas.clamav-${VERSION}-${ARCH}.fpk" >> $GITHUB_OUTPUT

          ls -lh dist/

      - name: Upload FPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: fnnas.clamav-${{ steps.version.outputs.version }}-${{ matrix.arch }}
          path: dist/fnnas.clamav-${{ steps.version.outputs.version }}-${{ matrix.arch }}.fpk
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: fnnas.clamav-${{ steps.version.outputs.version }}-x86_64
          path: ./dist
        continue-on-error: true

      - name: Download aarch64 artifact
        uses: actions/download-artifact@v4
        with:
          name: fnnas.clamav-${{ steps.version.outputs.version }}-aarch64
          path: ./dist
        continue-on-error: true

      - name: List downloaded files
        run: |
          echo "Downloaded files:"
          ls -lh dist/ || echo "No files found"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: ClamAV飞牛版 ${{ steps.version.outputs.version }}
          body: |
            ## ClamAV飞牛版 ${{ steps.version.outputs.version }}

            基于 ClamAV 的病毒扫描和防护软件

            ### 功能特性
            - 全盘扫描 / 自定义扫描
            - 病毒库更新
            - 文件隔离
            - 扫描历史记录
            - 批量威胁处理

            ### 下载说明
            | 文件 | 架构 | 适用设备 |
            |------|------|----------|
            | `fnnas.clamav-${{ steps.version.outputs.version }}-x86_64.fpk` | x86_64 | Intel/AMD 处理器 |
            | `fnnas.clamav-${{ steps.version.outputs.version }}-aarch64.fpk` | ARM64 | 树莓派/ARM 处理器 |

            ### 安装方法
            1. 根据你的设备架构下载对应的 FPK 文件
            2. 在飞牛OS应用商店中选择手动安装
            3. 上传FPK文件完成安装

            ---

            **完整更新日志请查看 [commits](https://github.com/${{ github.repository }}/commits/${{ steps.version.outputs.version }})**
          files: |
            dist/*.fpk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
