#!/bin/bash

# ClamAV 守护进程启动脚本
APP_NAME="clamav-daemon"

# 飞牛环境变量
APP_DEST="${TRIM_APPDEST}"
SERVER_BIN="${APP_DEST}/server/${APP_NAME}"

# 使用应用可写的动态数据目录存储 PID 和日志
PID_DIR="${TRIM_PKGVAR}"
PID_FILE="${PID_DIR}/${APP_NAME}.pid"
LOG_FILE="${PID_DIR}/${APP_NAME}.log"

case $1 in
start)
    # 检查是否已在运行
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE" 2>/dev/null)
        if [ -n "$PID" ] && ps -p "$PID" > /dev/null 2>&1; then
            echo "Service already running (PID: $PID)"
            exit 0
        else
            rm -f "$PID_FILE"
        fi
    fi

    # 检查二进制文件
    if [ ! -f "$SERVER_BIN" ]; then
        echo "Error: Server binary not found at $SERVER_BIN"
        echo "TRIM_APPDEST=$TRIM_APPDEST"
        exit 1
    fi

    # 确保目录存在
    mkdir -p "$PID_DIR"

    # 启动服务
    echo "Starting $APP_NAME..."
    echo "Server binary: $SERVER_BIN"
    echo "PID file: $PID_FILE"
    echo "Log file: $LOG_FILE"

    # 后台启动服务
    "$SERVER_BIN" >> "$LOG_FILE" 2>&1 &
    PID=$!

    # 保存 PID
    echo $PID > "$PID_FILE"

    # 等待服务启动
    sleep 2

    # 检查是否启动成功
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "Service started successfully (PID: $PID)"
        exit 0
    else
        echo "Failed to start service"
        echo "Check log at: $LOG_FILE"
        cat "$LOG_FILE"
        rm -f "$PID_FILE"
        exit 1
    fi
    ;;
stop)
    if [ ! -f "$PID_FILE" ]; then
        echo "Service not running (no PID file)"
        exit 0
    fi

    PID=$(cat "$PID_FILE" 2>/dev/null)
    if [ -z "$PID" ]; then
        echo "Invalid PID file"
        rm -f "$PID_FILE"
        exit 0
    fi

    if ps -p "$PID" > /dev/null 2>&1; then
        echo "Stopping $APP_NAME (PID: $PID)..."
        kill "$PID"

        # 等待进程结束（最多5秒）
        for i in {1..5}; do
            if ! ps -p "$PID" > /dev/null 2>&1; then
                break
            fi
            sleep 1
        done

        # 强制结束
        if ps -p "$PID" > /dev/null 2>&1; then
            kill -9 "$PID" 2>/dev/null
        fi

        rm -f "$PID_FILE"
        echo "Service stopped"
    else
        rm -f "$PID_FILE"
        echo "Service not running"
    fi
    exit 0
    ;;
status)
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE" 2>/dev/null)
        if [ -n "$PID" ] && ps -p "$PID" > /dev/null 2>&1; then
            echo "Service running (PID: $PID)"
            exit 0
        fi
    fi
    echo "Service not running"
    exit 3
    ;;
restart)
    $0 stop
    $0 start
    ;;
*)
    echo "Usage: $0 {start|stop|status|restart}"
    exit 1
    ;;
esac
